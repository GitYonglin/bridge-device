<app-left>
  <div class="sider sider-menu">
    <app-scroll-menu style="flex: 1;" [dbName]="dbName" [stateFunc]="menuStateFunc" #menu (menuChange)="selectBridge($event)"></app-scroll-menu>
  </div>
  <div class="main" style="width: 100%;">
    <div *ngIf="data?.template" class="task-template">
      <div class="text">模板</div>
    </div>
    <nz-tabset class="task-tabset" (nzSelectChange)="changeTabs($event)" [nzShowPagination]="false">
      <nz-tab nzTitle="基础信息">
        <div class="form-edit">
          <form nz-form [ngClass]="{'edit-on': appS.edit}" [formGroup]="formData" *ngIf="formData">
            <div>
              <app-form-item [row]="true" label="模板" [hidden]="!appS.edit">
                <nz-switch formControlName="template" nzCheckedChildren="是" nzUnCheckedChildren="否"></nz-switch>
              </app-form-item>
              <app-form-item label="梁号" [errors]="formData.get('name').errors">
                <input type="text" nz-input placeholder="请输入梁号" formControlName="name">
              </app-form-item>
              <app-form-item label="构建" [errors]="formData.get('component').errors">
                <nz-input-group class="tension-group" [nzAddOnAfter]="suffixButton">
                  <nz-select style="width: 100%;" nzPlaceHolder="请选择构建" formControlName="component"
                  (ngModelChange)="conponentChange($event)">
                    <nz-option [nzValue]="item.value" [nzLabel]="item.label"
                      *ngFor="let item of componentMneu$ | async">
                    </nz-option>
                  </nz-select>
                </nz-input-group>
                <ng-template #suffixButton>
                  <button nz-button nzType="primary" (click)="manualGroup()" [disabled]="!(formData.get('component').value)">分组</button>
                </ng-template>
              </app-form-item>
              <app-form-item label="梁长度" [errors]="formData.get('beamLength').errors">
                <input type="number" nz-input placeholder="请输入梁长度" formControlName="beamLength">
              </app-form-item>
              <app-form-item label="浇筑日期" [errors]="formData.get('castingDate').errors">
                 <nz-date-picker readonly formControlName="castingDate" placeholder="浇筑日期" [nzAllowClear]="false"></nz-date-picker>
              </app-form-item>
              <app-form-item label="张拉日期">
                 <nz-date-picker readonly formControlName="tensionDate" placeholder="张拉日期" [nzAllowClear]="false"></nz-date-picker>
              </app-form-item>

              <app-form-item label="施工员">
                <input type="text" nz-input placeholder="施工员" formControlName="operator">
              </app-form-item>
              <app-form-item label="监理员">
                <input type="text" nz-input placeholder="监理员" formControlName="supervisors">
              </app-form-item>
              <app-form-item label="自检员">
                <input type="text" nz-input placeholder="自检员" formControlName="qualityInspector">
              </app-form-item>
              <app-form-item label="张拉顺序" [row]="true">
                <input type="text" readonly nz-input placeholder="张拉顺序" [value]="sortJoin(formData?.get('sort').value)">
              </app-form-item>
            </div>
            <div>
              <app-add-other [formGroup]="formData" [edit]="appS.edit"></app-add-other>
            </div>
            <div>
              <tension-holes [data]="data" [formData]="formData" #holes (outSelectHole)="holeIndex = $event"></tension-holes>
            </div>
          </form>
          <div class="edit" *ngIf="!appS.edit"></div>
        </div>

        <div class="operation" *ngIf="menu?.projectId">
          <app-operat
            [dbName]="dbName"
            [formData]="formData"
            [addFilterFun]="addFilterFun"
            [updateFilterFun]="updateFilterFun"
            [coprState]="true"
            [valid]="formData?.valid"
            (outEdit)="onEdit($event)"
            (outEditOk)="editOk($event)"
            (outDelete)="delete()"
            (outCancelEdit)="cancelEdit()"
            (outModification)="onEdit(null, true)"
            >
            <button nz-button nzType="primary" (click)="upload()"
              [disabled]="!(data?.groutingInfo?.length > 0) || !uploading"><i nz-icon nzType="cloud-upload"
                nzTheme="outline"></i>上传</button>
            <button nz-button nzType="primary" (click)="test()" *ngIf="appS.platform === 'debug'">测试</button>
            <button nz-button nzType="primary" (click)="downHMI()" [disabled]="!(PLCS.connStr?.uid === 'tensionLink')" *ngIf="data?.id !== null && PLCS.plcState && !appS.edit && holeIndex !== null">张拉</button>
            <button nz-button nzType="primary" (click)="downHMITest()" [disabled]="!(PLCS.connStr?.uid === 'tensionLink')" *ngIf="data?.id !== null && appS.platform === 'debug' && holeIndex !== null">测试张拉</button>
          </app-operat>
        </div>
      </nz-tab>
      <nz-tab nzTitle="其他">
        <p>创建者：{{data?.user}}</p>
        <p>创建日期：{{data?.createdDate | date: "yyyy.MM.dd HH:mm"}}</p>
        <p>修改日期：{{data?.modificationDate | date: "yyyy.MM.dd HH:mm"}}</p>
      </nz-tab>
    </nz-tabset>
  </div>
</app-left>
<app-delete-modal *ngIf="deleteShow" (outDelete)="deleteOk($event)"></app-delete-modal>
<tension-manual-group *ngIf="mamualGroupState" (outCancel)="manualGroupCancel()" (outOK)="manualGroupOk($event)"[holes]="nowComponentHoleInfo"></tension-manual-group>
<nz-modal [(nzVisible)]="downState" nzTitle="下载数据" (nzOnCancel)="downState = false" (nzOnOk)="downHMI()" nzMaskClosable>
  <nz-alert nzType="error" [nzMessage]="item" *ngFor="let item of downMsg"></nz-alert>
  <nz-progress [nzPercent]="(upProgress / 8) * 100" nzType="circle" [nzWidth]="80"></nz-progress>
</nz-modal>

